# 基本概念

## 基本释义

操作系统是指控制和管理整个计算机系统的硬件和软件资源，并合理的组织调度计算机的工作和资源的分配；以提供给用户和其他软件方便的接口和环境。它是计算机系统中最基本的系统软件。

- 管理计算机软/硬件资源
- 向上层提供服务
- 最接近硬件的一层软件

## 基本功能

### 资源管理

- 处理机管理（CPU管理）
- 存储器管理（内存管理）
- 文件管理
- 设备管理（外部设备，如显示器等）

### 为上层提供服务

体现了封装的思想：操作系统将复杂的硬件功能封装成简单易用的功能提供给上层使用。

- GUI（图形化用户接口）
- 命令行接口（一般用于用户使用）
  - 联机命令接口（交互式）：命令行窗口，与操作系统交互使用，一次处理一条指令
  - 脱机命令接口（批处理）：将一批命令写入特殊的文件中（例如`.bat`文件）由操作系统进行批处理
  
- 程序接口（系统调用接口，一般用于应用程序使用）
  在程序中进行系统调用来使用程序接口，用户无法直接使用程序接口，只能通过程序代码来间接使用。一般程序接口由一组系统调用组成。

### 最接近硬件的软件

操作系统实现对硬件机器的拓展：指的是将CPU、内存、磁盘、显示器、键盘等硬件合理的组织起来，让各种硬件能够相互协调配合，进而实现更多复杂的功能。

## 基本特征

### 并发（最基本）

是指两个或多个事件在同一时间间隔内发生，这些事件宏观上是同时发生的，在微观上是交替发生的。

#### 并行与并发

并行是指两个或多个事件在同一时刻是同时发生的

#### 操作系统的并发性

指计算机系统中“同时”运行着多个程序，这些程序宏观上是同时运行的，微观上是交替运行的。

- 单核CPU，在同一时刻，只能同时运行一个程序
- 多个CPU，在同一时刻，能同时运行多个程序

### 共享（最基本）

是指资源共享。是指系统中的资源可供内存中多个并发执行的进程共同使用。

- 互斥共享方式：一个时间段内只允许一个进程访问，例如QQ、微信同时访问摄像头
- 同时共享方式：一个时间段内允许多个进程“同时”访问。“同时”，往往指代宏观上的同时，即在微观上是交替访问；当然也有可能是真正意义上的同时。例如，QQ、微信同时发送文件

#### 并发与共享

相互依存。如果不存在并发，那么就不存在同一时间段多个进程同时访问一个资源，就不存在共享。如果不存在共享，就不允许同一时间段多个进程交替访问同一个资源，就不存在并发。

### 虚拟

是指把一个物理上的实体变为若干个逻辑上的对应物。物理实体是实际存在的，逻辑上的对应物是用户感受到的。

#### 虚拟技术

- 空分复用技术（如，虚拟存储器技术）
- 时分复用技术（如，虚拟处理器技术）

### 异步

是指，在多道程序环境下，允许多个程序并发执行，但由于资源有限，进程的执行不是一贯到底的，而是走走停停的，以不可预知的速度向前推进。（多个程序的交替执行，在遇到获取共享资源权限的步骤上发生冲突并造成其中某些程序的阻塞等待获取资源）

## 历史发展

### 手工操作阶段

使用纸带机。缺点是用户使用时独立占用整个机器，且用户手工操作阶段速度与机器处理阶段速度相差巨大，造成机器资源浪费。

### 批处理阶段

#### 单道批处理系统

引入脱机输入/输出技术，由监督程序来进行输入/输出的控制。

优点是能够缓解人机处理速度的差异。缺点是资源的利用率还是很低。

连续一个接一个执行

#### 多道批处理系统

操作系统开始出现。优点是多道程序并发执行，资源共享使用，利用率高。缺点是缺少人机交互功能

作业调度程序同时选中多个上CPU，共享资源，并发执行。（利用处理其中一个进程的CPU空闲时间去处理另一个进程）

### 分时操作系统

计算机以时间片为单位，轮流为多个用户/作业提供服务，多个用户/作业通过终端与计算机进行交互。

优点是提供了人机交互功能。缺点是不能优先处理紧急任务。

### 实时操作系统

在该系统的控制下，计算机系统接收到外部信号后及时进行处理，并且要在严格的时限内处理完事件。特点是及时性和可靠性。

- 硬实时系统：必须在绝对严格的时限内完成处理，例如自动驾驶系统
- 软实时系统：能够接受偶尔的违反时限的处理，例如12306订票系统

优点是能够优先处理紧急任务。

### 网络操作系统

进行网络中资源的共享，计算机之间的通信

### 分布式操作系统

工作分布在所有的主机上并行、协调执行

### 个人计算机操作系统

例如windows操作系统

## 运行机制

### 运行的两类程序

#### 应用程序

运行在操作系统之上的程序

#### 内核程序

多个内核程序构成了操作系统的内核，内核是操作系统最核心的部分，也是操作系统中最接近硬件的部分。

### CPU执行的两类指令

CPU能够识别出一条指令是特权指令还是非特权指令，但是具体是否执行还要检验自身是否处于内核态

#### 特权指令

只能由操作系统来使用，也就是只有内核程序可以使用，特权指令对整个系统的影响性较大，不单单是影响某个应用程序

#### 非特权指令

### CPU两种处理器状态

CPU中有一个程序状态字寄存器（PSW），该寄存器使用内部的一个二进制位来记录当前CPU的处理器状态。一般1是内核态，0是用户态。

#### 内核态

CPU处于内核态时，说明此时正在执行的是内核程序，此时可以执行特权指令。

#### 用户态

CPU处于用户态时，说明此时正在执行的是应用程序，此时特权指令不能执行。

#### 状态间的切换

- 内核态`->`用户态，内核程序执行一条修改PSW的特权指令，修改标志位为用户态，该动作是操作系统主动让出CPU使用权。
- 用户态`->`内核态，由中断引起，中断信号使得硬件自动完成处理器状态的改变，操作系统重新获得CPU的使用权。

## 中断

### 作用

是让操作系统内核重新获取CPU使用权的唯一途径。

### 分类

#### 内中断（异常）

与当前执行的指令有关，中断信号来源于CPU内部

- **故障**
  由错误条件引起的，可能被内核程序修复。内核程序修复后将CPU使用权返还给应用程序，使得应用程序继续执行，例如缺页错误
- **终止**
  由致命错误引起，内核程序无法修复。一般不会再将CPU使用权返还给应用程序，而是直接终止应用程序。例如执行非法指令或指令参数错误
- **陷入**
  应用程序主动执行陷入指令（非特权指令），将CPU使用权交给操作系统内核，期望得到某些帮助。

#### 外中断

与当前执行的指令无关，中断信号来源于CPU外部

- 时钟中断
- I/O中断

### 基本实现原理

#### 检查中断信号

- 内中断：CPU在执行指令时会检查是否有异常发生
- 外中断：CPU每个指令执行周期末尾，会例行检查是否有外中断信号需要处理

#### 获取中断程序进行处理

不同的中断信号，需要用不同的中断程序进行处理。通常CPU会根据中断信号查询中断向量表，以此来找出相应的中断处理程序在内存中的存放位置。

<img :src="$withBase='/img/operating-system-interrupt-vector-table.png'" class="align-center"/>

## 系统调用

系统调用是操作系统提供给应用程序（程序员/编程人员）使用的接口。可以理解为一种可供应用程序调用的函数。应用程序可以通过系统调用来请求获得操作系统内核的服务。

一般涉及到共享资源的功能都需要操作系统内核来实现并通过系统调用接口来提供给上层用户，例如打印功能。

### 按功能分类

#### 设备管理

完成设备的请求/释放/启动等功能

#### 文件管理

完成文件的读/写/创建/删除等功能

#### 进程管理

完成进程的创建/撤销/阻塞/唤醒等功能

#### 内存管理

完成内存的分配/回收等功能

### 调用过程

1. 应用程序执行指令传递系统调用所需参数
2. 应用程序执行陷入指令，发生（内）中断
3. CPU转换为内核态，操作系统获得CPU使用权，并处理系统调用请求
4. 处理完毕后，CPU转换为用户态，CPU使用权返还给应用程序

## 体系结构

### 操作系统构成

#### 非内核部分（GUI）

#### 内核

- 与硬件关联交紧密的
  1. 时钟管理：时钟中断功能
  2. 中断处理：负责实现中断机制
  3. 原语：一种特殊的程序；处于操作系统的最底层，是最接近硬件的部分；具有原子性，即程序运行不可中断；运行时间较短，调用频繁。例如设备驱动、CPU状态切换等
  4. 进程间通信
- 不直接涉及硬件，更多的是对数据结构的操作
  1. 进程管理
  2. 存储器管理
  3. 设备管理

### 操作系统体系结构

#### 大内核

将操作系统的主要功能模块都作为系统内核（包含不涉及硬件的功能部分），运行在核心态。

- 优点：高性能，内核内部各种功能可以直接相互调用
- 缺点：
  1. 内核代码庞大，结构混乱，难以维护
  2. 大内核中某个功能模块出错，就可能导致整个系统崩溃

例如：UNIX、LINUX

#### 微内核

只把最基本的功能保留在内核（只包含与硬件关联较密切的功能部分）

- 优点：
  1. 内核功能少，结构清晰，方便维护
  2. 内核外的某个功能出错，不会导致整个系统崩溃
- 缺点：
  1. 需要频繁地在内核态与用户态之间切换，性能低
  2. 用户态下，各功能模块不可以直接相互调用，需要通过内核的消息传递功能来间接通信

例如：Windows NT

#### 分层结构

内核分多层，最底层（0层）是硬件，最顶层是用户接口。每层只可调用相邻的更低层提供的服务。

- 优点：
  1. 分层结构，便于调试验证各层功能
  2. 易于扩充、维护
- 缺点：
  1. 仅可调用相邻较低层的服务，但是层与层之间的界限很难确定
  2. 效率低，不能跨层调用，例如系统调用是需要调用最底层服务，但是只能层层递进，执行时间长

#### 模块化

内核分为各个模块，模块之间相互协作。主要分为主模块（只负责核心功能，如进程调度、内存管理等）和可加载模块（指可以动态加载到内核的新模块，加载无需重新编译整个内核）

- 优点：
  1. 模块间逻辑清晰，易于维护，确定好模块接口后可以并行开发
  2. 支持动态加载新的模块，增强了操作系统的适应性
  3. 任何模块都可以直接调用其他模块，无需采用消息传递进行通信，效率高
- 缺点：
  1. 模块间的接口定义未必合理、适用
  2. 模块间相互依赖，更难调式和验证

#### 外核

内核负责进程调度、进程通信等功能，外核负责为用户进程分配未经抽象的硬件资源（未经虚拟技术虚拟化映射的资源），且由外核负责保证资源使用安全

- 优点：
  1. 外核可直接给用户分配“不虚拟、不抽象”的硬件资源，使用户进程可以更灵活的使用硬件资源
  2. 减少了虚拟硬件资源的“映射层”（物理资源与逻辑资源的映射关系层），提升效率
- 缺点：
  1. 降低了系统的一致性
  2. 系统变得更加复杂

## 操作系统引导

开机时，引导操作系统运行起来的程序部分。

### 过程

<img :src="$withBase='/img/operating-system-CPU-guide.png'" class="align-center" />

1. CPU从主存的一个特定地址开始，取指令，执行ROM中的引导程序（先进行硬件自检，再开机）
2. 根据指令将磁盘的主引导记录读入内存（RAM），执行磁盘引导程序，扫描分区表
3. 从活动分区（主分区，即安装了操作系统的分区）读取分区引导记录，执行其中的程序
4. 从根目录下找到完整的操作系统初始化程序（即启动管理器）并执行，完成“开机”的一系列动作。

## 虚拟机

### 传统计算机

<img :src="$withBase='/img/os-traditional-computer.png'" class="align-center" />

### 虚拟机

使用虚拟化技术，将一台物理机器虚拟化为多台虚拟机器，每个虚拟机器可以独立运行一个操作系统。

#### 分类

- 直接运行在硬件上
  <img :src="$withBase='/img/os-first-class-of-vmm.png'" class="align-center" />
- 运行在宿主操作系统上
  <img :src="$withBase='/img/os-second-class-of-vm.png'" class="align-cneter" />

#### 对比

<img :src="$withBase='/img/os-comparing-of-two-vm.png'" class="align-center" />