# 线程

线程是一个基本的CPU执行单元，是程序执行流的最小单位。可以理解为一个“轻量级的进程”。

## 为什么引入线程

进程可能需要“同时”做很多事情，而传统的进程只能串行的执行一系列程序。为此，引入线程，来增加并发度，不仅进程间可以并发，进程内各线程间也可以并发。

## 引入线程之后带来的变化

- 资源分配、调用
  -   之前：传统进程机制中，进程是资源分配、调度的基本单位
  -   之后：进程是资源分配的基本单位，线程是调度的基本单位
- 并发性
  - 之前：只能进程间并发
  - 之后：各线程间也能并发，提升了并发性
- 系统开销
  - 之前：进程间并发，需要切换进程的运行环境，系统开销很大
  - 之后：线程间并发，如果是同一进程内的线程切换，则不需要切换进程环境，系统开销小

## 属性

- 线程是处理机调度的单位
- 多CPU计算机中，各个线程可占用不同的CPU
- 每个线程都有一个线程ID，线程控制块（TCB）
- 线程也有就绪、阻塞、运行三种基本状态
- 线程几乎不拥有系统资源
- 同一进程的不同线程间共享进程的资源
- 由于共享内存地址空间，同一进程中的线程间通信甚至无需系统干预
- 同一进程中的线程切换，不会引起进程切换
- 不同进程中的线程切换，会引起进程切换
- 切换同进程内的线程，系统开销很小
- 切换进程，系统开销很大

## 实现方式

### 用户级线程（User-Level Thread）

<img :src="$withBase='/img/os-thread-ult.png'" class="align-center"/>

早期的操作系统（例如Unix）只支持进程，不支持线程。当时的“线程”是由线程库实现的。

- 线程管理工作由应用进程通过线程库来完成
- 线程切换不需要CPU由用户态转换为内核态
- 操作系统意识不到用户级线程的存在
- 优点：用户级线程管理不需要CPU切换到内核态，所以线程管理开销小，效率高
- 缺点：当一个用户级线程被阻塞后，整个进程都会被阻塞，并发度不高。多个线程不能在多核处理机上并行运行

### 内核级线程（Kernel-Level Thread）

<img :src="$withBase='/img/os-thread-klt.png'" class="align-center"/>

又叫内核支持线程，是由操作系统支持的线程，现代大多数操作系统都实现了内核级线程，如windows、Linux。**操作系统只能“看得见”内核级线程，因此内核级线程才是处理机分配的单位。**

- 线程管理工作由操作系统完成
- 线程切换需要CPU变态，因为涉及到从用户线程到对应的内核支持线程的映射
- 操作系统能够意识到内核级线程的存在
- 优点：某个线程阻塞后，别的线程可以继续执行，线程之间的并发能力强，多线程可在多核处理机上并行执行
- 缺点：线程切换需要变态，线程管理成本高，开销大

### 组合方式

在支持内核级线程的系统中，根据用户级线程和内核级线程的映射关系进行划分

#### 一对一模型

<img :src="$withBase='/img/os-muti-thread-one-to-one.png'" class="align-center"/>

一个用户级线程映射到一个内核级线程。每个用户进程有与用户级线程同数量的内核级线程

- 优点：当一个线程被阻塞后，别的线程还可以继续执行，并发能力强。多线程可以在多核处理机上并行执行
- 缺点：一个用户进程会占用多个内核级线程，线程切换由操作系统内核完成，需要切换到核心态，因此线程管理成本高，开销大

#### 多对一模型

<img :src="$withBase='/img/os-muti-thread-more-to-one.png'" class="align-center"/>

多个用户级线程映射到一个内核级线程。且一个进程只被分配一个内核级线程。

- 优点：用户级线程的切换在用户空间即可完成，不需要切换到核心态，线程管理的系统开销小，效率高

- 缺点：当一个用户级线程被阻塞后，整个进程都会被阻塞，并发度不高。多个线程不可在多核处理机上并行运行

#### 多对多模型

<img :src="$withBase='/img/os-muti-thread-more-to-more.png'" class="align-center"/>

n用户级线程映射到m个内核级线程（n>=m）。每个用户进程对应m个内核级线程。

- 优点：克服了多对一模型并发度不高的缺点（一个阻塞全体阻塞），又克服了一对一模型中一个用户进程占用太多内核级线程，开销太大的缺点。

## 状态与转换

<img :src="$withBase='/img/os-thread-status-change.png'" class="align-center" />

## 组织与控制

<img :src="$withBase='/img/os-thread-orgnization.png'" class="align-center" />