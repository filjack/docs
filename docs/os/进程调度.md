# 进程调度

## 调度时机

### 需要进行调度

#### 当前进程主动放弃处理机

- 进程正常终止
- 进程运行过程中发生异常
- 进程主动请求阻塞、例如等待I/O

#### 进程被动放弃处理机

- 分给进程的时间片用完
- 有更紧急的事件需要处理，例如I/O中断
- 有更高优先级的进程进入就绪队列

### 不能进行调度

- 在处理中断过程中。中断处理过程复杂，与硬件密切相关，很难做到在中断处理过程中进行进程切换
- 进程在操作系统内核程序临界区[^1]中（在普通临界区中可以）*（一个时间段内只允许一个进程使用的资源称为临界资源，各进程互斥访问。而临界区则是访问该资源的代码段。内核程序临界区一般用来访问某种内核数据结构，比如就绪队列。）*
- 原子操作过程中，例如原语。

## 调度方式

### 非剥夺式调度

又叫非抢占式调度，只允许进程主动放弃处理机，在运行过程中即便有更紧迫的事件到达，当前进程依然会继续使用处理机直到该进程正常终止或主动要求进入阻塞态

这种方式实现简单，系统开销小，但是无法处理紧急任务，只适用于早期的批处理系统

### 剥夺式调度

又叫抢占式调度，当一个进程正在处理机上运行时，如果有一个优先级更高的任务需要使用处理机，则操作系统立刻暂停当前进程，将处理机分配给优先级更高的进程

这种方式可以优先处理更紧急的任务，也可以实现让进程按时间片轮流执行的功能（通过时钟中断），适用于分时操作系统、实时操作系统

## 进程切换

### 进程调度与进程切换

狭义的进程调度：指从就绪队列中选中一个要运行的进程（这个进程可以是刚刚被暂停执行的进程，也可以是另一个进程，后一种情况就需要进程切换）

进程切换：是指一个进程让出处理机，由另一个进程占用处理机的过程

广义的进程调用：包含选择一个进程和进程切换两个步骤。

### 切换过程

1. 对原进程数据进程保存
2. 对新进程数据进行读入（例如：程序计数器、程序状态字、各种数据寄存器等处理机现场信息，这些信息一般保存在PCB中）

进程的切换是有代价的，过于频繁的进程切换、调度，必然会使整个系统的效率降低。系统的大部分时间都花在了进程切换上，真正用于执行进程的时间减少。

## 调度器

又叫调度程序，用来决定哪个进程可以分配到处理机运行（通过[调度算法](./调度算法.md)），可以运行多长时间（占用的时间片）

### 触发时机

- 创建新进程
- 进程退出
- 运行的进程阻塞
- I/O中断发生（可能唤醒某些阻塞进程）

非抢占式调度策略，只有运行进程阻塞或退出时才能触发调度程序工作

抢占式调度策略，在每个时钟中断或每k个时钟中断会触发调度程序工作

### 进程与线程

- 在不支持内核级线程的操作系统中，调度程序的处理对象是进程
- 在支持内核级线程的操作系统中，调度程序的处理对象是内核级线程

## 闲逛进程

当就绪队列中没有其他进程时，闲逛进程（idle）被调度

### 特性

- 优先级最低
- 可以是0地址指令[^2]，占用一个完整的指令周期（指令周期末尾例行检查中断）*（0地址指令意味着不需要访存，甚至不需要访问CPU中的寄存器）*
- 能耗低





[^1]: 一个时间段内只允许一个进程使用的资源称为临界资源，各进程互斥访问。而临界区则是访问该资源的代码段。内核程序临界区一般用来访问某种内核数据结构，比如就绪队列。
[^2]: 0地址指令意味着不需要访存，甚至不需要访问CPU中的寄存器