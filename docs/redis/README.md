# redis

## 基本概念

`Remote DIctionary Server`，是一个基于内存的键值型`NoSQL`数据库

### 特征

1. 键值型，值支持多种数据结构
2. 单线程、每个命令具备原子性（6.0版本的多线程仅仅在于网络请求处理方面，而核心命令执行依然是单线程）
3. 低延迟、速度快（基于内存、`IO`多路复用、良好的编码）
4. 支持数据持久化
5. 支持主从集群、分片集群
6. 支持多编程语言客户端

### `key`的层级结构

`redis`的`key`允许有多个单词形成层级结构，多个单词之间使用`:`隔开（具体使用什么符号作为分隔符看个人习惯，但是在同一个项目中尽量使用同一种符号作为分隔符，避免混淆）

```shell
项目名:业务名:类型:id
```

在命令行窗口中，都是以长字符形式展示，但是在某些`redis`客户端上，可以分级展示

### `SQL vs NoSQL`

#### `sql`

> 一般使用在数据结构固定、相关业务对数据安全性、一致性要求高的场景中

1. 结构化数据
2. 数据之间的关联性，比如用户表、商品表、订单表之间的关联关系，可以使用外键关联
3. `SQL`查询语法固定
4. 一般支持事务管理，`ACID`需求
5. 一般采用磁盘存储
6. 一般不支持分布式

#### `NoSQL`

> 一般使用在数据结构不固定、对一致性、安全性要求不高、对查询性能要求高的场景下

1. 非结构化数据
   - 键值型（`redis`）
   - 文档型（例如，`JSON`文档）（`MongoDB`）
   - 图类型（`Neo4j`）
   - 列类型（`HBase`）
2. 非关系型
3. 非`SQL`，没有固定的查询语法
4. 事务的`BASE`理论
5. 一般采用内存存储
6. 一般支持分布式

## [数据结构](./Redis数据结构.md) 

- [字符串](./redis数据结构.md##字符串) 

- [散列](./redis数据结构.md##散列) 

- [列表](./redis数据结构.md##列表) 

- [集合](redis数据结构.md##集合) 
- [有序集合](./redis数据结构.md##有序集合) 
- [HyperLogLog](./redis数据结构.md##HyperLogLog) 
- [位图](./redis数据结构.md##位图) 
- [地理坐标](./redis数据结构.md##地理坐标) 
- [流](./redis数据结构.md##流) 

## 实用功能

- [数据库管理](./redis数据库管理.md) 
- [自动过期](./redis自动过期.md) 
- [流水线](./redis流水线.md) 
- 事务
- Lua脚本
- 模块
- 持久化
- 发布与订阅
- 多机功能
  - 复制
  - Sentinel
  - 集群

## 应用场景

- 缓存
- 锁（SETNX）
- 文章长度计数功能（STRLEN）、文章部分预览功能（GETRANGE）
- 存储日志（缓存、APPEND）
- id生成器（INCR、SETNX）
- 计数器（INCR）
- 分组计数器（HINCRBYFLOAT、HINCRBY）
- 限速器（DECR）
- 短网址生成映射（HSET、HGET）
- 用户登录会话、会话令牌、过期时间等等（HSET、HGET）
- 存储图数据，将图中边的起点和终点组合成字段，权重作为值存储（HSET、HMSET）
- 存储文章信息，将一遍文章所有相关信息，例如标题，作者，内容等等存储到一个hash中（HSET、HMSET、HEXISTS）
- 先进先出队列，可以用于秒杀场景，保证用户购买的顺序（LPUSH、RPOP）
- 分页（LRANGE）
- 代办事项列表（LPUSH、RPOPLPUSH）
- 带有阻塞功能的消息队列，例如需要邮箱激活的注册操作（BLPOP等）
- 唯一计数器，例如记录网站的用户数量（SET）
- 打标签，将一个对象的所有的标签放到一个集合中（SET）
- 点赞，使用集合来存储对同一个内容的用户点赞数量（SET）
- 投票，使用不同的集合来存储不同投票结果的用户（SET）
- 社交关系，利用集合来存储用户的关注者和关注该用户者信息（SET）
- 抽奖，使用集合保存所有抽奖用户，使用随机获取其中某一部分用户作为幸运用户（SRANDMEMBER）
- 共同关注，使用集合的交集来处理
- 推荐关注，通过已关注的集合，筛选出一些用户作为种子，求取这些种子的共同关注，再从这些共同关注中筛选出一些作为推荐关注
- 使用反向索引构建商品筛选器，通过对商品打标签，可以通过筛选标签来进一步筛选商品，具体就是，每一个标签都有一个集合维护具有该标签的商品，当需要根据不同的标签进行筛选商品时，需要对这些标签的集合进行交集运算。
- 排行榜（有序集合）
- 按时间线排序（有序集合，分数为成员的时间戳）
- 商品推荐（有序集合，将用户浏览或购买一个商品之后浏览的其他商品构成一个有序集合，当用户每次浏览或者购买该商品后，用户再次浏览的其他有序集合商品的分数自增，之后做推荐时，根据分数倒序排列取前几个值就可以形成一次较为有效的商品推荐）
- 自动补全提示（有序集合）、结合排行榜（用户输入后使用的自动补全，因为创建自动补全需要创建大量的集合，所以需要经常删除一些不常用的、冷门的集合）
- 唯一计数器（使用HyperLogLog进行计数，非常节省内存空间）
- 每周/月度/年度计数（PFMERGE）
- 检验垃圾信息、去重（使用HyperLogLog进行基数计算，可以很方便的得出是否存储过该值）
- 用户行为记录（使用位图来记录执行某一特定行为的用户，用户ID设置为位图偏移量，用户执行了该行为，位图相应位置置为1）
- 使用位图存储0-1矩阵
- 紧凑计数器（使用位图存储长度比long小的整数）
- 查找附近用户（地理坐标功能）
- 消息队列（流）
- 构建数据库迭代器（SCAN）
- 带有自动移除特性的缓存程序（EXPIRE）
- 带有自动释放特性的锁（SETNX、EXPIRE）
- 自动过期的登录会话（SET、EXPIRE、TTL）
- 自动淘汰冷门数据（SET、EXPIRE）

## 使用注意

1. [字符串与散列](./Redis字符串与散列.md) 

## 数据结构

常见的一般是下面的八种。基本类型是前五种。

### `List`

```shell
[A->B->C->D]
```

列表类型类似于`java`中的`LinkedList`结构，是一个双向链表，既可以支持正向操作又可以支持反向操作。

- 有序
- 元素可以重复
- 插入和删除快
- 查询速度一般

常用来保存一些有序的数据，例如朋友圈点赞，评论等等。可以用来模拟栈、队列、阻塞队列。

### `Set`

```shell
{A,B,C}
```

集合，与`java`中的`HashSet`类似，可以看做是一个`value`为`null`的`HashMap`

- 无序
- 元素不可重复
- 查找快
- 支持交集、并集、差集等功能

### `SortedSet`

```shell
{A:1, B:2, C:3}
```

是一个可排序的集合，与`java`中的`TreeSet`功能类似，但是底层数据结构大不相同。`SortedSet`中每一个元素都有一个`score`属性，可以基于`score`属性对元素进行排序，底层实现是一个跳表（`SkipList`）加`hash`表。

- 可排序
- 元素不重复
- 查询速度快

### `GEO`

```shell
{A:(120.3,30.5)}
```



### `BitMap`

```shell
0110110101110101011
```



### `HyperLog`

```shell
0110110101110101011
```

## 常用命令

命令行输入 `help @<group>`进行查看

## 客户端连接方式

### `jedis`

1. 多线程环境下线程不安全，需要结合线程池使用

### `SpirngDataRedis`

1. 整合了`Lettuce`和`Jedis`
2. 提供了`redisTemplate`

## 应用场景

1. 共享`session`
   由于session在不同服务器之间是不共享的，可以使用redis来代替session。
   - 由于session当前用户当前会话独享的，但是redis是共享的，所以需要注意保存的信息的key的定义的唯一性
   - redis内存时有限的，随意不能无限制，无期限的保存信息，每次保存信息时注意设置过期时间
   - 注意选择数据在redis中的数据类型进行存储

2. [缓存](./redis缓存.md) 
3. [全局唯一ID](./全局唯一ID.md) 
4. [超卖问题]()
5. 基于List、SortedSet点赞列表、排名列表
6. 计数器
7. [分布式锁](./超卖问题.md###分布式锁) 
8. 主从一致性
9. [消息队列](./消息队列.md) 
10. 基于Set的关注、取关等
11. 统计
12. [分布式缓存](./分布式缓存.md) 
13. [哨兵机制](./哨兵机制.md) 
14. [分片集群](./分片集群.md) 
15. [多级缓存](./多级缓存.md) 

## 使用注意

1. `keys`命令可以进行模糊查询，但是查询效率得不到保证。由于`redis`是单线程的，当数据量过大时，不建议使用`keys`命令进行模糊查询。