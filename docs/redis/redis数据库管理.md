# 数据库管理

Redis是一个键值对数据库服务器，可以根据键的名字对数据库中的键值对进行索引以及操作。

## 键的存储

在redis数据库中，键的存储顺序是无序的。

## 常用数据库命令

### 切换数据库

```shell
SELECT db_num
```



一个Redis可以包含多个数据库，默认情况下，Redis服务器在启动时会创建16个数据库，使用号码进行标识，从0号开始。当用户使用客户端与服务器连接时，默认连接的0号数据库。

Redis不允许同一个数据库中存在相同的键，但是允许不同的数据库中存在相同的键，可以在不同的库中存储不同类型的数据，数据可以使用相同的键名。

### 模糊查询键

```shell
KEYS pattern
```

该命令需要检查数据库中所有键，并一次性将所有符合条件的键全部返回，所以当数据库包含的键数量比较大时，使用该命令可能会导致服务器被阻塞。

### 迭代

因为使用KEYS命令可能会导致服务器阻塞，可以使用SCAN命令，该命令是一个迭代器，每次调用都会从数据库中返回一部分键，改名令会迭代所有类型的键。MATCH可以进行模糊匹配；COUNT可以限制返回的键的数量，但是COUNT标识的只是一个期望值，每次迭代返回的键的数量仍然是不确定的，不过，如果设置一个较大的COUNT值是肯定有助于获取更多的键的。

```shell
SCAN cursor [MATCH pattern] [COUNT n]
```

返回的结果由两部分组成

- 第一个元素是下次迭代时需要传递的游标
- 第二个元素是一个列表，包含本次迭代获取的键

对于返回的数据库键有两点需要注意

1. 可能会返回重复的键，需要客户端自行处理
2. 每次返回的键的数量是不确定的，但只要返回的下次迭代的游标不为0，那么迭代就没有结束

SCAN命令为完整的迭代提供以下保证：

- 从迭代开始到结束整个过程，一直存在于数据库中的键一定会被返回
- 如果一个键在迭代过程中被添加，那么在整个过程中，该键是否会被返回不确定
- 如果一个键在迭代过程中被移除了，那么SCAN在它移除以后不会再返回该键，但是在这个键被移除之前仍然有可能返回该键
- 不管数据库中的键如何变化，迭代总是有始有终的，不会出现循环迭代或者其他无法终止的情况

对于游标，它不占用任何资源，不需要申请，不需要释放，每个客户端可以独立的使用自己的游标进行迭代。用户可以随时终止一个迭代，或者随时开始一个新的迭代，不会浪费任何资源，也不会引发任何问题。

#### 散列迭代

```shell
HSCAN hash cursor [MATCH pattern] [COUNT n]
```

#### 集合迭代

```shell
SSCAN set cursor [MATCH pattern] [COUNT n]
```

#### 有序集合迭代

```shell
ZSCAN sorted_set cursor [MATCH pattern] [COUNT n]
```

### 随机获取键

```shell
RANDOMKEY
```

该命令会随机送数据库中返回一个键

### 排序

用户可以通过SORT命令对列表、集合、有序集合中的元素进行排序

```shell
SORT key [LIMIT offset count] [ASC|DESC] [ALPHA]
```

默认根据数字值，从小到大排序。

- ALPHA配置，根据字符串值进行排序
- LIMIT配置，获取部分结果，offset指示需要跳过的数量，count指示返回的结果数量

### 检查给定键是否存在

```shell
EXISTS key [key ...]
```

返回存在的键的个数

### 获取数据库包含的键值对数量

```shell
DBSIZE
```

### 查看键类型

```shell
TYPE key
```

- 对于字符串、列表、集合、流，该命令返回结果非常直观，就是对应的英文名。

- 对于有序集合，会返回zset
- 对于HyperLogLog、位图，因为这两种键底层使用字符串实现，会返回string
- 对于地理位置，底层使用有序集合实现，会返回zset



### 修改键名

```shell
RENAME old_key new_key
```

该命令会将旧key的名字修改为新key，如果新key存在，则覆盖（先删后增）

```shell
RENAMENX old_key new_key
```

该命令只有在新key不存在的情况下才会进行重命名

### 移动键到指定数据库

```shell
MOVE key destination_db
```

将键移动到指定数据库，如果键不存在或者指定数据库中有重名的键，则不移动

### 删除键

```shell
DEL key [key ...]
```

该命令是采用同步方式执行的，如果待移除的键非常多，可能会造成执行该命令服务器被阻塞

```shell
UNLINK key [key ...]
```

该命令采用异步方式移除键，当用户调用该命令时，该命令只会在数据库中移除对该键的引用，而对键的实际移除操作则交由后台线程执行，所以该命令不会造成服务器阻塞。

### 清空数据库

```shell
FLUSHDB
```

该命令会以同步方式遍历用户当前正在使用的数据库并执行移除操作，可能会造成服务器的阻塞。可以使用带有`async`的该命令，使用异步方式清空数据库（就像是UNLINK的执行方式一样）

```shell
FLUSHALL
```

该命令以同步方式遍历服务器所有数据库，并执行移除操作，可能会造成服务器阻塞，可以使用带有`async`的该命令，使用异步方式清空所有数据库（执行方式就像UNLINK命令一样）

### 互换数据库

```shell
SWAPDB x y
```

该命令接受两个数据库号码，然后对两个数据库进行互换。因为互换数据库这一操作可以通过调整指向数据库的指针来实现，所以这个过程不需要移动数据库中的任何键值对，该命令的时间复杂度为O(1)，并且执行该命令不会导致服务器阻塞。