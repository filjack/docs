# 索引

## 索引概念

是帮助MySQL**高效获取数据**的**数据结构（有序）**。在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。

### 优点

1. 提高数据检索效率，降低数据库I/O成本
2. 通过索引对数据进行排序，降低数据排序的成本，降低CPU的消耗

### 缺点

1. 索引列也是要占用空间的
2. 索引大大提高了查询效率，同时却也降低更新表的速度，如对表进行INSERT、UPDATE、DELETE时，效率降低

## 索引结构

MySQL的索引是在存储引擎层实现的，不同的存储引擎有不同的结构

<img :src="$withBase='/img/sql-index-1.png'" class="align-center" />

### B+Tree

> 每个节点存放到一个页中

最常见的索引，大部分引擎都支持。MySQL在B+Tree的基础上做了优化，每个叶子节点可以获得相邻叶子节点的引用。当树的高度超过3层时，需要考虑分库分表

#### B+Tree vs B-Tree

1. 所有数据都会出现在叶子结点
2. 叶子结点形成一个单项链表

### Hash

底层数据结构用哈希表实现，只有精确匹配索引列的查询才有效，不支持范围查询。

采用一定的哈希算法，将键值换算成新的hash值，映射到对应的槽位上，然后存储在hash表中。

在MySQL中，支持Hash索引的是Memory引擎，而InnoDB中具有自适应hash功能，hash索引是存储引擎根据B+Tree索引在指定条件下自动构建的

#### 特点

1. 只能用于对等比较，不支持范围查询
2. 无法利用索引完成排序操作
3. 查询效率高，通常只需要一次检索就可以了，效率通常要高于B+Tree索引



### R-Tree（空间索引）

是MyISAM引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用很少

### Full-Text（全文索引）

是一种通过建立倒排索引，快速匹配文档的方式。类似于Lucene、Solr，ES



## 索引分类

<img :src="$withBase='/img/sql-index-2.png'" class="align-center" />

### InnoDB

在InnoDB存储引擎中，根据索引的存储形式，又可以分为

#### 聚集索引（Clustered Index）

将数据与索引放到一起存储，索引结构的叶子结点保存了行数据。聚集索引必有，且只能有一个。

##### 选取规则

1. 如果存在主键，则主键索引就是聚集索引
2. 如果不存在主键，将使用第一个唯一（UNIQUE）索引作为聚集索引
3. 如果表没有主键，或没有合适的唯一索引，则InnoDB会自动生成一个rowid作为隐藏的聚集索引。

#### 二级索引（Secondary Index）

将数据与索引分开 存储，索引结构的叶子节点关联的是对应的主键。可以存在多个。

<img :src="$withBase='/img/sql-index-3.png'" class="align-center" />

## 索引语法

### 创建索引

```sql
create [unique|fulltext] index index_name on table_name (index_col_name,...);
```

- 关联单个字段称为单列索引
- 关联多个字段称为联合索引

### 查看索引

```sql
show index from table_name;
```



### 删除索引

```sql
drop index index_name on table_name;
```



## SQL性能分析

### SQL语句执行频次

`SHOW [GLOBAL|SESSION] STATUS` 可以查看服务器的状态信息，`SHOW GLOBAL STATUS LIKE 'Com_______'`可以查看服务器INCERT、UPDATE、DELETE、SELECT语句的频次。

```sql
SHOW GLOBAL STATUS LIKE 'Com_______';
```

执行结果

```
Com_binlog	0
Com_commit	0
Com_delete	0
Com_import	0
Com_insert	0
Com_repair	0
Com_revoke	0
Com_select	18
Com_signal	0
Com_update	0
Com_xa_end	0
```

通过观察频次，来确定该数据库主要是哪种语句过多，应该主要哪方面（比如查询）的性能。

### 慢查询日志

该日志记录了所有执行时间超过指定参数（long_query_time，单位秒，默认10秒）的所有SQL语句的日志。

查看是否开启慢查询日志，以及当前默认时间是多少

```sql
show VARIABLES like 'slow_query_log'
show VARIABLES like 'long_query_time'
```

开启慢查询日志，需要在MySQL的配置文件（/etc/my.cnf）中配置如下信息：

```bash
# 开启慢查询日志
slow_query_log = 1
# 设置慢日志的时间为2秒，SQL语句执行时间超过2s，就会被视为慢查询，记录慢查询日志
long_query_time = 2
```

一般日志存放位置为 `/var/lib/mysql/localhost-slow.log`

### profile详情

查看数据库版本是否支持profile，以及是否开启profile

```sql
# 查看是否支持profile
select @@have_profiling;
# 查看是否开启
select @@profiling;
# 开启profile
set profiling = 1;
# 关闭profile
set profiling = 0;
```



show profiles 能够在做SQL优化时帮助我们了解时间都耗费到哪里去了。

- 查看每一条SQL的耗时情况

  ```sql
  show profiles;
  ```

  结果如下

  | QueryId | Duration   | Query                |
  | ------- | ---------- | -------------------- |
  | 92      | 0.00091025 | SHOW STATUS          |
  | 110     | 0.0002535  | select * from `user` |

- 查看指定QueryId的SQL语句各个阶段的耗时情况
  ```sql
  show profile for query 110;
  ```

  结果如下

  | Satus                         | Duration |
  | ----------------------------- | -------- |
  | starting                      | 0.000054 |
  | Executing hook on transaction | 0.000003 |
  | starting                      | 0.000005 |
  | checking permissions          | 0.000004 |
  | Opening tables                | 0.000036 |
  | init                          | 0.000003 |
  | System lock                   | 0.000006 |
  | optimizing                    | 0.000003 |
  | statistics                    | 0.000011 |
  | preparing                     | 0.000013 |
  | executing                     | 0.000043 |
  | end                           | 0.000002 |
  | query end                     | 0.000002 |
  | waiting for handler commit    | 0.000005 |
  | closing tables                | 0.000005 |
  | freeing items                 | 0.000054 |
  | cleaning up                   | 0.000007 |

- 查看指定QueryID的SQL语句的CPU使用情况
  ```sql
  show profile cpu for query 110;
  ```

  | Satus                         | Duration | CPU_user | CPU_system |
  | ----------------------------- | -------- | -------- | ---------- |
  | starting                      | 0.000054 | 0.000000 | 0.000000   |
  | Executing hook on transaction | 0.000003 | 0.000000 | 0.000000   |
  | starting                      | 0.000005 | 0.000000 | 0.000000   |
  | checking permissions          | 0.000004 | 0.000000 | 0.000000   |
  | Opening tables                | 0.000036 | 0.000000 | 0.000000   |
  | init                          | 0.000003 | 0.000000 | 0.000000   |
  | System lock                   | 0.000006 | 0.000000 | 0.000000   |
  | optimizing                    | 0.000003 | 0.000000 | 0.000000   |
  | statistics                    | 0.000011 | 0.000000 | 0.000000   |
  | preparing                     | 0.000013 | 0.000000 | 0.000000   |
  | executing                     | 0.000043 | 0.000000 | 0.000000   |
  | end                           | 0.000002 | 0.000000 | 0.000000   |
  | query end                     | 0.000002 | 0.000000 | 0.000000   |
  | waiting for handler commit    | 0.000005 | 0.000000 | 0.000000   |
  | closing tables                | 0.000005 | 0.000000 | 0.000000   |
  | freeing items                 | 0.000054 | 0.000000 | 0.000000   |
  | cleaning up                   | 0.000007 | 0.000000 | 0.000000   |

### explain执行计划

通过explain/desc命令获取MySQL如何执行SELECT语句的信息，包括在SELECT语句执行过程中表如何连接和连接的顺序。

```sql
explain select columns_name from table_name where condition
```

- id
  select查询的序列号，表示查询中执行select子句或者是操作表的顺序（id相同，执行顺序从上到下；id不同，值越大越先执行）
- select_type
  表示select的类型，常见的取值有SIMPLE（简单表，即不使用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、UNION（UNION中的第二个或者后面的查询语句）、SUBUERY（select/where之后包含了子查询）等
- type
  表示连接类型，性能由好到差的连接类型为NULL（一般业务查询不可能优化到null，例如`select 'A'`）、system（一般是访问系统表）、const（一般根据主键或唯一索引访问）、eq_ref、ref（一般使用非唯一索引访问）、range、index、all（全表扫描）。
- possible_key
  显示可能应用在这张表上的索引，一个或多个
- Key
  实际使用的索引，如果为NULL，则没有使用索引
- Key_len
  表示索引中使用的字节数，该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下，长度越短越好
- rows
  MySQL认为必须要执行查询的行数，在InnoDB引擎的表中，是一个估计值，可能并不总是精确的
- filtered
  表示返回结果的行数占需读取行数的百分比，越大越好
- Extra
  额外信息

## 索引使用

## 索引设计原则

